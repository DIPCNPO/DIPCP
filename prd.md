# DIPCP 产品需求文档 (PRD)

## 📋 文档信息

- **项目名称**: DIPCP - Decentralized Intellectual Property Collaboration Platform
- **版本**: v2.0
- **创建日期**: 2025年10月21日
- **最后更新**: 2025年11月6日
- **文档类型**: 产品需求文档

## 🎯 项目概述

### 1.1 项目背景

DIPCP 是一个基于 **GitHub Pages** 的去中心化协作平台，它彻底解决了传统协作模式中**高成本、IP 归属权模糊和中心化审查**的痛点。平台采用**“数据即裁判”**的激励机制，鼓励创作者通过分叉、引用和市场认可来孵化 IP 价值。

### 1.2 产品定位

DIPCP是一个**无服务器协作平台**，任何设备上打开网页即可使用。系统采用零运维成本架构，大部分业务逻辑在客户端实现，通过GitHub仓库存储所有数据，用Github Actions保证数据安全和一致性。产品专注于内容创作和引用、评价机制。

**核心特点**：
- **零运维成本**: 无服务器架构，无需维护
- **零学习成本**: 打开即用，无需学习复杂技术，界面友好直观
- **零门槛参与**: 除了GitHub账号注册外，完全零门槛，任何人都能参与
- **完全透明**: 所有参与者、参与过程全部明文公开
- **全程可追溯**: 每个操作都有完整的历史记录可追踪
- **延时同步**: 数据的统计结果每天更新一次，可支持千万级的并发用户
- **流畅体验**: 原生JS单页应用架构，启动时加载所有页面，避免页面刷新和加载时序问题

### 1.3 目标用户

- **内容创作者**: 想要协同创作故事内容的用户
- **读者用户**: 寻求全新阅读体验的用户
- **IP发掘者**: 寻找优秀IP的企业用户

### 1.4 定义

- **用户**：拥有Github账号，并使用DIPCP平台的人
- **作品**: 多个用户协同创作的IP内容，由文章构成，通过链接的形式组成的网状结构
- **文章**：构成作品的最小单位，内容以文字为主，可包含图片、音频，可用过文件名和其他文章链接
- **作者**：参与作品创作，发表文章的用户
- **根作者**：某作品的第一位作者
- **作者仓库**：作者存储作品的Github空间，一个作者可以拥有多个仓库
- **作品仓库**：所有作者同作品名的仓库集群，完整的作品分布在这些仓库中
- **根仓库**：某作品根作者的仓库，作品中所有文章的投票结果统一保存在这里
- **读者**：阅读他人文章的用户，有权为文章投票
- **投票**：读者对每篇文章都可以点赞、点踩或路过
- **CLA**：贡献者许可协议，作者签署的将自己拥有的著作权转让给DIPCNPO的法律文件
- **权限**：只针对文章，区分作者和读者，根作者没有特权
- **路径**：文章的定位方式，格式为“作者/仓库名/目录/文件名.扩展名”，自动获取最新版本的内容

## 🎯 功能需求

### 2.1 核心功能
- **多浏览器支持**：支持Chrome，Safari，Firefox这三种内核的主流浏览器
- **原生响应式设计**: 自动适应各种尺寸的屏幕，保持一致的用户体验
- **极简风格**：界面极简，功能至上
- **支持主题切换**：提供暗黑和明亮两种主题，并自动跟随系统设置
- **多语言支持**：初期提供中英日三语种，之后覆盖主流语言，用户可以输入第三方AI的APIKEY，实现多语言翻译功能
- **部署方式**: GitHub Pages静态部署
- **技术栈**: 原生JavaScript，Github Actions
- **零运维成本**: 完全静态，无需任何服务器，将Github仓库作为数据库，用Github Actions做后台计算
- **零学习成本**: 用户无需了解Git、分支、合并等概念，系统自动处理
- **权限隔离**: 只有作者才能编辑、合并自己编写的内容
- **文件类型**: 仅支持Markdown、txt格式的文本，jpg、png格式的图片和MP3格式的音频
- **链接系统**: 支持跨仓库的文件链接和引用
- **投票系统**: 读者对每篇文章都可以投票，数据永久保存
- **动态加载功能**: 用户在阅读时动态加载文章中的链接，减少延迟
- **编辑器**: 集成Markdown编辑器，支持实时预览
- **离线编辑**: 编辑时无需网络环境，提交时批量上传
- **版本对比**: 可显示文章的变更历史
- **页面状态缓存**: 所有页面自动保存，下次进入时恢复离开时的状态
- **理论最大承载量**：每个作品每天最多可处理1176万名用户的投票数据
- **数据统计**：商业运作时，统计文章字数和引用量的程序需要另外编写
- **轮询功能**：根据设定的时间轮询用户自己的issues，获取列表，如有未读的issue，在通知按钮上显示红点。
- **自动同步**：如果setting的last_update超过24小时，则自动同步。向根仓库的Issue#1中写入commit，内容为path、vote（-1,0,1）这2个字段的数组。之后获取最新的统计数据，解压后保存到creation表。
- **签署CLA**：显示CLA的内容供作者签署。
- **创建仓库**：自动生成仓库，设置分支保护，只允许所有者提交，在根目录下生成一个"DIPCP.md"的文件，内容包括作品名和指向根仓库的路径。批量上传.github/workflows/vote_workflow.yml，LICENSE和CONTRIBUTING文件。如果是根作者，还会发送邀请加入DIPCNPO的邀请。

### 2.2 登录功能
- **选择语言**：根据浏览器设置自动选择语言，暂不支持的默认为英语
- **Github注册、获取令牌**：帮助用户注册并获取令牌，需有详细的操作指南，后期要配上YouTube视频，包括移动和PC端，有多语言字幕
- **验证令牌有效性**：验证过期时间，相关权限是否许可，每小时API访问量
- **自动路由**：根据本地存储的信息，自动跳转到相应页面

### 2.3 作品选择功能
- **作品一览**：可以通过作品一览表查看平台上发布的所有作品，并可以根据语言、分类和简介内容来进行查找
- **近期访问**：快速找到自己近期浏览过的作品
- **创建作品**：作为根作者，可输入作品类别，作品名和简介。签署CLA后，自动生成仓库，保存到浏览历史后跳转到编辑页
- **接受邀请**：作者在创建根仓库后会收到加入DIPCNPO的邀请的issue，直接自动接受
- **直接输入地址**：也允许用户直接输入地址打开作品仓库，但如果根目录下没有".DIPCP"文件则提示出错
- **自动下载**：选中或输入仓库地址后，自动下载仓库中根目录下的全部文件（以.开头的除外），已经保存过的跳过，然后下载 **.voting.json**，跳转到阅读页面

### 2.4 菜单功能
- **导航条按钮**：除了登录和作品列表页，其余页面顶部都有导航条，有5个图标按钮，分别为返回，阅读，通知，提交，设定。
- **返回**：回到作品选择页。
- **阅读**：打开阅读页面，自动打开之前阅读的页面，并定位到上次离开的位置。
- **通知**：显示申请链接和申请结果的通知一览表。
- **通知**：显示待提交文件的一览表。
- **设定**：显示设定界面。

### 2.5 阅读功能
- **加载文章**：如果setting中有当前文章，则直接加载，否则默认显示当前仓库的README文件。没有README，则显示目录结构。
- **工具条**：有前进，后退，目录，编辑，信息，点赞，点踩，路过8个图标按钮。工具条和导航条两个区域不随内容滚动，始终保持在顶部。
- **版权许可区**：工具条下方用卡片样式显示示版权许可，作品名，文件名，作者名，版本，创建时间，更新时间。
- **权限区分**：作者阅读自己编写的文章时可看到点赞和点踩的数值，但不显示点赞，点踩，路过按钮。
- **阅读区**：将md格式自动排版，提供良好的阅读体验，所有引用的文字都可以点击跳转，凡打开过的文章都在本地永久保存。链接的图片和音频自动加载，自动缩放适应显示区域。如果设置了APIKEY，还可以自动翻译成浏览器设定的默认语言，并保存翻译结果。
- **作者留言区**：作者发表的创作感想之类，读者可以选择显示或隐藏，不设读者评论区。
- **投票**：在读者离开当前页面时如果还没有对其投过票，会弹出对话框，要求点赞、点踩还是路过三选一。也可以在页面顶部随时修改。
- **内容更新**：用户可以在设定中选择每次打开页面时是重新下载还是直接读取缓存。
- **阅读路径**：保存用户的阅读路径，随时可以在路径中前进或后退。
- **目录查看**：除了点击文中的链接进行阅读之外还可以直接查看当前作者的目录树，选择任意文章阅读。
- **自动加载**：自动下载当前页面中所有链接的文章，如果需要翻译也在后台自动完成。
- **编辑**：点击编辑按钮，如果是其他作者的文章，跳转到编辑页面，进入新建模式。如果是自己的，显示模态框，询问新建还是编辑。
- **首次创作**：如果读者看到某个章节觉得不满意，想要重写或补充内容时，可点击编辑按钮进入创作模式。首次进入时要签署CLA协议，之后系统自动为其在自己名下创建一个和根仓库同名的作者仓库。
- **作品信息**：点击信息按钮，打开模态框，显示当前作品的统计信息，可以强制刷新。

### 2.6 编辑功能
- **工具条**：有撤销，反撤销，保存，预览，删除，上传，提交，链接8个图标按钮。工具条和导航条两个区域不随内容滚动，始终保持在顶部。
- **标题区**：页面顶部要显示作品名和文件名，新建模式下为文件名输入框。
- **创作面板**：工具条下面是内容编辑区和作者留言区，位置大小固定，内部可滚动。
- **保存**：用户编辑时会定时自动保存。点击保存按钮后系统根据files表中的文件名，将内容中所有和文件名一致的词语自动替换为指向该文件的链接。
- **选择引用**：当files中有多个同名文件时，自创的优先，如果都是别人的，则需手动选择引用哪个链接。多处需要引用时，可记住之前的选择。
- **上传**：只接受txt,md,jpg,png,mp3格式的文件，txt和md上传后自动将内容添加在当前光标位置，其他媒体格式文件，自动在当前光标位置插入链接。图像统一保存在/images目录中，MP3保存在/audios目录中。图像自动缩放为长宽不超过1600像素，保留原有比例和格式。音频上传前判断长度，不能超过5分钟。上传同名媒体文件显示询问模态框，是否覆盖。
- **预览**：以阅读时的格式显示，用前进后退按钮验证链接的正确性。
- **删除**：删除当前文档。
- **链接**：点击链接按钮后如果是没有提交的文件，显示提示模态框，告知请先提交。否则弹出模态框，在下拉列表中显示当前作品所有其他作者还没有建立链接的文章。选则其中一个，可查看过滤掉md标签后的内容，并且自动统计有多少个和当前文件同名的词语。点击确定就自动向作者发送申请，申请进度保存在links表中。

### 2.7 通知功能
- **收到申请**：当作者收到新的申请后会有提醒。
- **申请列表**：根据收到时间显示列表，点击后首先下载申请的文章，以预览模式显示自己的文章，其中如果有和申请文章名相同的词语就自动替换，没有就在文末加一个链接。定位到第一个链接处，点击可阅读。如果觉得可以就批准，将替换后的内容保存到本地，和pending表，并通过Issue向申请者发送批准的反馈。如果不批准，输入拒绝理由并发送反馈。
- **反馈列表**：申请反馈的列表，点击其中一项，显示具体内容，并根据反馈内容更新links表的状态，完成后关闭Issue。

### 2.8 提交功能
- **一览表**：显示所有待提交的文件，可以勾选或全选。
- **批量提交**：将勾选的文章或媒体文件批量提交到自己的仓库。

### 2.9 设定功能
- **加星功能**：每个用户有一次给DIPCP项目和当前作品根仓库加星的机会。
- **设定主题**：手动切换主题色。
- **设定语言**：手动切换界面语言。
- **设定字体**：改变显示字体的大小。
- **同步时间**：设定轮询获取新通知的频率，1-10分钟之间。
- **总是刷新**：设定每次打开页面时用缓存数据还是强制刷新。
- **显示留言**：是否显示作者留言。
- **第三方AI**：选择是否使用第三方AI进行多语言翻译，如果打开设定，需要选择API提供商，如OpenAI，Deepseek，Gemini等，输入APIKEY。可以添加多个。
- **退出**：退出用户账号，并清除所有数据，回到登录页。

### 2.10 数据存储功能
- **只用Indexeddb**：统一使用Indexeddb作为本地存储介质，不使用localStorage和cookie。
- **保存文章**：无论是从Github获取的文件，还是自己编写的文件，md格式的都保存在files表中，无需加密。
- **读取文章**：先去files表中查找指定文章，如果不存在或设定为总是更新则自动下载。将其路径保存到setting的当前文章键值中。
- **删除文章**：删除自己编写的文章。
- **保存KV**：将一个KV对保存到KVStorage表，将值加密。
- **获取KV**：从KVStorage表获取值，将值解密。
- **投票**：给其他作者的文件进行投票，可接受的值为-1,0,1。检查voting表中是否已经有该文章的投票记录，一致就忽略，不一致或没有就更新。
- **清理投票**：返回所有投票数据后将其清空。
- **获取媒体文件**：先去medias表中查找指定文章，如果不存在或设定为总是更新则自动下载。
- **文本下载**：下载给定链接的文件，完成后先解析其中有哪些图像和音频的链接，开启多线程下载。生成file对象，保存到files表，用回调函数返回file对象。
- **媒体下载**：下载给定链接的文件，保存到数据库，返回媒体文件。
- **文本批量下载**：一次性下载多个文本文件，下载前检查是否有缓存。
- **媒体批量下载**：一次性下载多个媒体文件，下载前检查是否有缓存。
- **媒体链接解析**：从文章中解析出所有的媒体链接。
- **文本链接解析**：从文章中解析出所有的文本链接。
- **翻译**：如果设置了第三方API，可调用API获取翻译结果，如果失败，并且设置了多个APIKEY，则尝试下一个，直到全部失败，通知调用方。翻译过程中，用回调函数返回流式结果，完成后保存到翻译字段，用回调函数返回file对象。
- **获取全部历史记录**：读取全部的作品记录，并按照最后阅读时间倒序排列
- **更新作品记录**：更新记录

## 🔧 技术架构

### 3.1 系统架构

完全无服务器架构，部署在Github Pages上 
原生JS + octokit/rest.js (官方GitHub REST API客户端)
业务逻辑层 (纯客户端) 
数据存储层 (GitHub仓库) 

### 3.2 技术栈选择

- **架构**: 单页应用(SPA) + 完全JS动态生成
- **框架**: 原生JavaScript (ES6+)
- **UI组件**: 原生HTML/CSS/JavaScript动态生成
- **路由**: 原生JavaScript路由系统

### 3.3 数据文件

#### 3.3.1 Github端数据文件
- **creations.tsv** 在DIPCNPO/creations的根目录下有一个creations.tsv文件，记录所有使用该平台发布的作品信息。
包括以下字段：
	repository : string,  根仓库地址，不包括https://github.com/
	createdAt : datetime, 创建时间
	name : string, 作品名称
	description : string, 简介
	language : string, 语言
	category : string, 类别
	articles : number, 文章数
	authors : number, 作者数
	readers : number, 读者数
	likes : number, 点赞数
	hates : number, 点踩数
	pass : number, 路过数
	daily_voting : number, 每日投票数

- **.voting.json** 在每个根项目的根目录下有一个.voting.json文件，包含所有文件的统计信息和用户投票记录。只能通过投票工作流进行修改。
{
	last_commit : number, 最后处理的commit编号
	authors : array, 作者列表（按字母排序）
	readers : array, 读者列表（按字母排序）
	likes : number, 点赞数
	hates : number, 点踩数
	pass : number, 路过数
	daily_voting : number, 每日投票数
	article s: [{
		path : string, 文件路径
		voting : array,
		[
			{
				username : string, 用户名
				vote : number, 投票，-1点踩，0路过，1点赞 
			}
		]
		likes : number,  赞数
		hates : number,  踩数
		pass : number,  路过
	}]
}
#### 3.3.2 本地数据
初次启动时创建Indexeddb数据库和7个表。
- **KVStorage表**：保存所有KV数据, value字段要加密
{
	key: string
	value: string
}
- **files表**：保存文本文件，以**path**为主键，对repo字段建索引
{
	path : string , 标准路径（默认''）
	repo : string , 仓库名（默认''）
	owner : string , 作者（默认''）
	filename : string , 文件名（默认''）
	content : string , 内容（默认''）
	translation : string , 翻译（默认''）
	vote : number, -2：未投票 -1：踩，0：路过，1：赞（默认-2）
	scrollTop : number, 滚动高度（默认0） 
}
- **pending表**：本地编辑或上传但还为提交的文件，以**path**为主键，对repo字段建索引
{
	path : string , 标准路径（默认''）
	repo : string , 仓库名（默认''）
}
- **links表**：本人文件和他人链接状态文件，以自增**id**为主键，对repo字段建索引
{
	id ：number， 自增ID
	repo : string , 仓库名（默认''）
	localPath : string , 自己创作文章的标准路径
	remotePath : string , 别人创作文章的标准路径
	state ：number，1-申请中，2-已链接
}
- **medias表**：保存媒体文件，以**path**为主键
{
	path : string , 标准路径
	data : bytes, 二进制文件内容
	contentType : string , 扩展名
}
- **voting表**：保存需要提交的投票数据，以**path**为主键。
{
	path : string , 标准路径
	vote : number, -1：踩，0：路过，1：赞
}
- **creations表**：保存自己阅读过的作品，以**repository**为主键，对name字段建索引。
{
	repository : string,  根仓库地址，不包括https://github.com/
	createdAt : datetime, 创建时间
	name : string, 作品名称
	description : string, 简介
	language : string, 语言
	category : string, 类别
	articles : number, 文章数
	authors : number, 作者数
	readers : number, 读者数
	likes : number, 点赞数
	hates : number, 点踩数
	pass : number, 路过数
	daily_voting : number, 每日投票数
	last_read: datetime, 最后阅读时间
	voting ：string， 解压缩后的.voting.json
}

以下两个对象保存在KVStorage中
- **user**：和用户认证相关的内容，用户登录后，常驻内存
{
	username ：string， Github用户名
	pen_name ：string， 笔名
	token : string， 访问令牌
	email : string, 邮件
	CLA ：bool， 是否签署过CLA
	creations: array[], 本人的作品仓库
}
- **setting**：和设定相关的内容，初次启动时生成默认值，之后从数据库中读取，常驻内存
{
	DIPCP_stard：bool， 是否给DIPCP项目加星（默认false）
	creation_stard:array, 作品加星列表（默认false）
	dark_mode：bool， 是否暗黑模式（默认true）
	language：string，界面语言，（默认为浏览器设定的语言）
	font_size: number，系统字体（默认14px）
	sync_interval: number，同步间隔（默认5分钟，范围1-10分钟）
	last_update：datetime，投票数据最后更新时间（默认null）
	always_refresh: bool, 每次打开页面都获取最新版本（默认false）
	show_message: bool, 在阅读时显示作者留言（默认true）
	third_party：bool, 使用第三方API（默认false）
	third_parties：array[， 第三方API，默认[]
		{
			provider:string, 供应商名
			APIKEY：string，
		}
	]
	read_path：array[]， 阅读路径
	read_path_index：number，阅读位置（默认-1）
	cursor_position：number，编辑状态下的编辑位置（默认0）
	current_page: string， 当前用户访问的页面（默认''）
	current_article：string，当前阅读或编辑的文章，（默认''）
	current_repo: string，当前阅读的作品，（默认''）
}


#### 3.3.3 文件格式
所有文章都以md格式保存
第一行pen_name:string
第二行version:number
第三行update_time:datatime
第四行create_time:datatime
第五行以后，文章正文
分割线-*-*-
作者留言

### 3.4 自动化工作流

#### 3.4.1 投票工作流
- 读者每天向作品根仓库的Issue #1写入commit，其中包含path、vote这2个字段的数组。
- 每小时Github自动触发根仓库的vote_workflow。
- 先读取.voting.json文件，以path为key创建hashmap，再为每个voting，以username为key创建hashmap。
- 读取issue1的last_commit编号，从该编号+1开始调用GithubAPI获取后面的所有commit，一次100条。
- 每条commit依次处理。
- 获取issue的用户。
- 将用户添加到读者列表
- 每个文章依次处理。
- 从路径中解析出文章的作者，加入作者列表
- 确认发起issue的不是文章的作者。
- 根据path获得Voting的hashmap，查找发起issue的用户有没有对这个文章投过票。
- 如果有，并且结果一致，就忽略。
- 如果没有或结果不一致，就添加或修改记录，同时更新本文章和本作品的likes、hates、pass的数目。
- 循环处理每个文章。
- 更新last_commit和daily_voting，循环处理commit。
- 判断获取的commit数量和API调用次数，如果数量不足100，或调用超过4900次就保存.voting.json，再将其压缩为.voting.zip格式，提交修改，结束工作流。
- 否则继续拉取剩余的commit。

#### 3.4.2 CLA工作流
- 作者向DIPCNPO/creations仓库提交新Issue，其中包括CLA文件内容，如果是根作者，还要包括项目信息。
- 自动触发cla_workflow。
- 将cla文件保存到DIPCNPO/CLA仓库的根目录中。
- 如果是根作者，则还要将项目信息写入DIPCNPO/creations/creations.tsv文件，压缩为creations.zip，提交修改。
- 向根作者发出加入DIPCNPO的邀请。

#### 3.4.3 统计工作流
- creations仓库每24小时自动触发一次statistics_workflow。
- 获取DIPCNPO/creations/creations.tsv
- 循环读取每个作品，获取根仓库中的.voting.json，对其文章数，作者数，读者数，点赞数，点踩数，路过数，每日投票数进行统计，
- 将结果更新到creations.tsv，压缩为creations.zip
- 根据文章数，作者数，读者数，点赞数，每日投票数生成5个排行榜的md文件，取前100位，保存在DIPCNPO/creations/目录下。
- 批量提交修改。

## 🚀 开发任务

### 4.1 已完成
- [x] **SPA架构设计**: 设计单页应用架构和路由系统
- [x] **应用主入口**: 开发app.js核心文件
- [x] **i18n服务**: 开发多语言支持的服务组件
- [x] **GitHub API集成**: 完善GitHub服务集成
- [x] **资源加载器**: 分批多线程加载所有JS资源
- [x] **用户登录系统**: 用户登录和使用条款和隐私政策的显示
- [x] **主题和国际化**: 实现主题切换和多语言支持
- [x] **通用模态框系统**: 开发可复用的模态框组件，替换所有原生对话框
- [X] **文件管理功能**: 实现文件树和编辑功能
- [X] **CLA签署**: 实现CAL协议签署保存功能
- [X] **用户仓库创建**: 为用户创建自己的仓库
- [X] **状态管理**: 废弃localStorage，全局状态管理和持久化
- [X] **导航条**: 简化，去掉权限管理和文字显示
- [X] **设定页**: 添加设定字体、刷新设定、显示控制、第三方AI功能
- [X] **浏览页**: md格式预览，添加链接跳转等的功能
- [X] **编辑页**: 全面重写
- [X] **通知页**: 全面重写
- [X] **后退按钮**: 从设定页中移到导航条，不清除数据

### 4.3 待完成
- [ ] **性能优化**: 优化SPA性能和用户体验
- [ ] **用户测试**: 进行用户测试和反馈收集
- [ ] **正式版本发布**: 发布稳定版本